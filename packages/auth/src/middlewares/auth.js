const _=require("lodash"),tokenManager=require("../managers/token"),authenticated=async(e,s,t)=>{const n=process.env.JWT_SECRET;if(!n)throw new Error("Missing JWT_SECRET");const o=e.header("x-app-auth-access-token");if(!o)return s.status(400).send("Access denied. Missing required token");const r=tokenManager.verify(o,n);if(!r)return s.status(400).send("Access denied. Bad token");const c=await tokenManager.getUserFromTokenPayload(r);if(!c)return s.status(400).send("Access denied. Gone");e.accessToken=o,e.user=c,t()},authorized=(e=[])=>async(s,t,n)=>{if(!s.user)return t.status(400).send("Unauthorized: Access denied");if(e.length===0)return n();if(_.intersection(s.user.roles,e).length===0)return t.status(403).send("Forbidden: Access denied");n()};module.exports={authenticated,authorized};
