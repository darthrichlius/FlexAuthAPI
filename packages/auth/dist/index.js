var t=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var A=t((ss,U)=>{U.exports={APP_DEBUG_PREFIX:"auth"}});var l=t((ts,O)=>{var{appDebugger:C}=require("@app/lib/utils"),{APP_DEBUG_PREFIX:$}=A();O.exports={info:C(`${$}:info`),error:C(`${$}:error`)}});var j=t((ns,F)=>{var Je=require("node:path"),{logger:p}=require("@app/lib/utils");F.exports=e=>{p.configure([p.withMongoDbTransport("mongodb://localhost/node-template",{level:"error"}),p.withFileTransport(Je.resolve(e,"logs/log.log")),p.withConsoleTransport()])}});var v=t((os,J)=>{var I;J.exports={getDbClient:()=>I,setDbClient:e=>I=e}});var g=t((as,B)=>{var N;B.exports={getModels:()=>N,setModels:e=>N=e}});var V=t((is,G)=>{var{connect:Ne,attach:Be}=require("@app/auth-db/detached"),{userDbSchema:Ge}=require("@app/auth-db/models/schemas"),{setDbClient:Ve}=v(),{setModels:We}=g();G.exports=()=>{try{let e={},r=Ne();Be(r,[{name:"User",schema:Ge}]).map(n=>{e={...e,[n.modelName]:n}}),Ve(r),We(e)}catch(e){throw new Error(e)}}});var L=t((cs,H)=>{var W=require("path"),m=require("fs"),ze=require("https"),z=l();H.exports=(e,r)=>{let s=W.join(W.resolve(e),"../../nginx/certs"),n="key.pem",o="cert.pem";if(!m.existsSync(`${s}/${n}`)||!m.existsSync(`${s}/${o}`))throw z.error("SSL certificates missing."),new Error("SSL certificates missing.");let a=m.readFileSync(`${s}/${n}`,"utf8"),c=m.readFileSync(`${s}/${o}`,"utf8"),T={key:a,cert:c},x=ze.createServer(T,r);return z.info("HTTPS server created in development mode..."),x}});var Y=t((us,Q)=>{var{getDbClient:K}=v(),{onExit:X,onUncaughtError:He,onUnhandledRejectionError:Le}=require("@app/lib/handlers");Q.exports=e=>{e.on("SIGINT",async()=>{await X(0,async()=>{let r=K();r&&await r.close()}),process.exit(0)}),e.on("SIGTERM",async()=>{await X(0,async()=>{let r=K();r&&await r.close()}),process.exit(0)}),e.on("uncaughtException",He),e.on("unhandledRejection",Le)}});var re=t((ds,ee)=>{var Z=require("express"),Ke=require("helmet");ee.exports=e=>{e.use(Ke()),e.use(Z.json()),e.use(Z.urlencoded({extended:!0}))}});var te=t((ls,se)=>{var{reqError:Xe}=require("@app/lib/api/middlewares");se.exports=e=>{e.use(Xe)}});var oe=t((ps,ne)=>{var Qe=require("http"),Ye=l();ne.exports=e=>{let r=Qe.createServer(e);return Ye.info("HTTP server created..."),r}});var E=t((gs,ue)=>{var ae=require("jsonwebtoken"),{getModels:Ze}=g(),er=()=>Ze().User,ie=e=>e.getAccessTokenPayload(),ce=(e,r)=>ae.sign(e,r),rr=(e,r)=>{try{return ae.verify(e,r)}catch{return}},sr=(e,r)=>{let s=ie(e);return ce(s,r)},tr=async e=>{let r="email";return await er().findOne({[r]:e[r]})};ue.exports={defineAccessTokenPayload:ie,createAccessToken:ce,generateDefaultAccessTokenPayload:sr,getUserFromTokenPayload:tr,verify:rr}});var k=t((ms,le)=>{var nr=require("lodash"),de=E(),or=async(e,r,s)=>{let n=process.env.JWT_SECRET;if(!n)throw new Error("Missing JWT_SECRET");let o=e.header("x-app-auth-access-token");if(!o)return r.status(400).send("Access denied. Missing required token");let a=de.verify(o,n);if(!a)return r.status(400).send("Access denied. Bad token");let c=await de.getUserFromTokenPayload(a);if(!c)return r.status(400).send("Access denied. Gone");e.accessToken=o,e.user=c,s()},ar=(e=[])=>async(r,s,n)=>{if(!r.user)return s.status(400).send("Unauthorized: Access denied");if(e.length===0)return n();if(nr.intersection(r.user.roles,e).length===0)return s.status(403).send("Forbidden: Access denied");n()};le.exports={authenticated:or,authorized:ar}});var ge=t((hs,pe)=>{var{Router:ir}=require("express"),{authenticated:cr}=k(),{asyncError:ur}=require("@app/lib/middlewares"),S=ir(),dr=(e,r)=>{r.sendStatus(200)};S.get("/ping",(e,r)=>{r.sendStatus(200)});S.get("/__test__/authenticated",[cr],ur(dr));pe.exports=S});var R=t((qs,me)=>{var u=require("joi"),h={fullname:u.string().min(5).max(30),email:u.string().min(5).max(255).email(),password:u.string().min(8).max(30),roles:u.array().items(u.string().valid("admin","user")).min(1)};me.exports={userSchema:h,registerSchema:u.object({fullname:h.fullname.required(),email:h.email.required(),password:h.password.required()})}});var ye=t((ys,qe)=>{var lr=require("joi"),{userSchema:he}=R();qe.exports={loginSchema:lr.object({username:he.email.required(),password:he.password.required()})}});var we=t((fs,fe)=>{var{resourceManager:pr}=require("@app/auth-db/services"),{getModels:gr}=g(),q=()=>gr().User,mr=async e=>await q().findOne(e),hr=async e=>await q().findOne({_id:e}),qr=async e=>{let r=q(),s=e.roles||"user";return await new r({...e,roles:s}).save()},yr=async(e={})=>{let r=q();return await pr.getItems(r,e)};fe.exports={getById:hr,exists:mr,register:qr,list:yr}});var xe=t((ws,Te)=>{var b=require("bcrypt"),fr=async(...e)=>await b.compare(...e),wr=async(e,r=10)=>{let s=await b.genSalt(r);return await b.hash(e,s)};Te.exports={hash:wr,verify:fr}});var _=t((Ts,ve)=>{var Tr=we(),xr=xe(),vr=E();ve.exports={userManager:Tr,passwordManager:xr,tokenManager:vr}});var Re=t((vs,Se)=>{var xs=require("lodash"),ke=require("express").Router(),{validate:Er}=require("@app/lib/api/helpers"),{asyncError:kr}=require("@app/lib/middlewares"),{loginSchema:Sr}=ye(),{userManager:Rr,passwordManager:br,tokenManager:Ee}=_(),_r=async(e,r)=>{let s=Er(Sr,e.body);if(s)return r.status(400).send(JSON.stringify(s));let n=await Rr.exists({email:e.body.username});if(!n)return r.status(404).send("Invalid credentials");if(!await br.verify(e.body.password,n.password))return r.status(401).send("Invalid credentials");let a=Ee.defineAccessTokenPayload(n),c=await Ee.createAccessToken(a,process.env.JWT_SECRET);return r.send(c)};ke.post("/",kr(_r));Se.exports=ke});var Pe=t((Es,Me)=>{var M=require("lodash"),y=require("express").Router(),{validate:Mr}=require("@app/lib/api/helpers"),{authenticated:_e,authorized:Pr}=k(),{registerSchema:Dr}=R(),{userManager:P,passwordManager:Ur,tokenManager:be}=_(),{asyncError:D}=require("@app/lib/middlewares"),Ar=async(e,r)=>{let s=e.user;return r.json(M.pick(s,["_id","fullname","email","roles"]))},Cr=async(e,r)=>{let s=await P.list();return r.json(s)},$r=async(e,r)=>{let s=Mr(Dr,e.body);if(s)return r.status(400).send(JSON.stringify(s));if(await P.exists({email:e.body.email}))return r.status(400).send("A user with that email already exists");let o=await Ur.hash(e.body.password);e.body.password=o;let a=await P.register(M.pick(e.body,["fullname","email","password"])),c=M.pick(a,["_id","fullname","email"]),T=be.defineAccessTokenPayload(a),x=await be.createAccessToken(T,process.env.JWT_SECRET);return r.header("x-app-auth-access-token",x).send(c)};y.get("/me",[_e,Pr(["user"])],D(Ar));y.get("/",_e,D(Cr));y.post("/",D($r));Me.exports=y});var Ue=t((ks,De)=>{var Or=ge(),Fr=Re(),jr=Pe();De.exports={api:Or,user:jr,auth:Fr}});var Ce=t((Ss,Ae)=>{var{api:Ir,auth:Jr,user:Nr}=Ue();Ae.exports=e=>{e.use("/api/auth",Jr),e.use("/api/users",Nr),e.use("/api",Ir)}});var Oe=t((Rs,$e)=>{var Br=["DEBUG","PORT","JWT_SECRET"],Gr=()=>Br.find(r=>{if(!process.env[r])return!0});$e.exports=()=>{let e=!0;if(Gr())throw e=!1,new Error("RuntimeError: missing required Env");e||process.exit(1)}});var je=t((bs,Fe)=>{var Vr=j(),Wr=V(),zr=L(),Hr=Y(),Lr=re(),Kr=te(),Xr=oe(),Qr=Ce(),Yr=Oe();Fe.exports={config:Vr,db:Wr,dev:zr,handlers:Hr,middlewareBefore:Lr,middlewareFinally:Kr,prod:Xr,routes:Qr,sanity:Yr}});var Zr=require("express"),d=Zr(),f=process.env.NODE_ENV||"";require("@dotenvx/dotenvx").config({path:`.env${f?"."+f:""}`});var w,es=l(),i=je();i.config(__dirname);i.handlers(process);i.sanity();i.db();i.middlewareBefore(d);i.routes(d);i.middlewareFinally(d);["test","production"].includes(f)?w=i.prod(d):w=i.dev(__dirname,d);var Ie=process.env.RUN_TEST&&process.env.RUN_TEST_PORT?process.env.RUN_TEST_PORT:process.env.PORT||5001;w.listen(Ie,()=>{es.info(`... Running in ${f||"development"} mode on PORT :${Ie}...`)});module.exports=w;
