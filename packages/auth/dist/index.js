var t=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var O=t((ss,U)=>{U.exports={APP_DEBUG_PREFIX:"auth"}});var l=t((ts,N)=>{var{appDebugger:A}=require("@app/lib/utils"),{APP_DEBUG_PREFIX:C}=O();N.exports={info:A(`${C}:info`),error:A(`${C}:error`)}});var I=t((ns,$)=>{var je=require("node:path"),{logger:p}=require("@app/lib/utils");$.exports=e=>{p.configure([p.withMongoDbTransport("mongodb://localhost/node-template",{level:"error"}),p.withFileTransport(je.resolve(e,"logs/log.log")),p.withConsoleTransport()])}});var v=t((os,j)=>{var F;j.exports={getDbClient:()=>F,setDbClient:e=>F=e}});var g=t((as,J)=>{var G;J.exports={getModels:()=>G,setModels:e=>G=e}});var V=t((cs,B)=>{var{connect:Ge,attach:Je}=require("@app/auth-db/detached"),{userDbSchema:Be}=require("@app/auth-db/models/schemas"),{setDbClient:Ve}=v(),{setModels:We}=g();B.exports=()=>{try{let e={},r=Ge();Je(r,[{name:"User",schema:Be}]).map(n=>{e={...e,[n.modelName]:n}}),Ve(r),We(e)}catch(e){throw new Error(e)}}});var L=t((is,H)=>{var W=require("path"),m=require("fs"),ze=require("https"),z=l();H.exports=(e,r)=>{let s=W.join(W.resolve(e),"../../nginx/certs"),n="key.pem",o="cert.pem";if(!m.existsSync(`${s}/${n}`)||!m.existsSync(`${s}/${o}`))throw z.error("SSL certificates missing."),new Error("SSL certificates missing.");let a=m.readFileSync(`${s}/${n}`,"utf8"),i=m.readFileSync(`${s}/${o}`,"utf8"),T={key:a,cert:i},x=ze.createServer(T,r);return z.info("HTTPS server created in development mode..."),x}});var Y=t((us,Q)=>{var{getDbClient:K}=v(),{onExit:X,onUncaughtError:He,onUnhandledRejectionError:Le}=require("@app/lib/handlers");Q.exports=e=>{e.on("SIGINT",async()=>{await X(0,async()=>{let r=K();r&&await r.close()}),process.exit(0)}),e.on("SIGTERM",async()=>{await X(0,async()=>{let r=K();r&&await r.close()}),process.exit(0)}),e.on("uncaughtException",He),e.on("unhandledRejection",Le)}});var re=t((ds,ee)=>{var Z=require("express"),Ke=require("helmet");ee.exports=e=>{e.use(Ke()),e.use(Z.json()),e.use(Z.urlencoded({extended:!0}))}});var te=t((ls,se)=>{var{reqError:Xe}=require("@app/lib/api/middlewares");se.exports=e=>{e.use(Xe)}});var oe=t((ps,ne)=>{var Qe=require("http"),Ye=l();ne.exports=e=>{let r=Qe.createServer(e);return Ye.info("HTTP server created..."),r}});var E=t((gs,ue)=>{var ae=require("jsonwebtoken"),{getModels:Ze}=g(),er=()=>Ze().User,ce=e=>e.getAccessTokenPayload(),ie=(e,r)=>ae.sign(e,r),rr=(e,r)=>{try{return ae.verify(e,r)}catch{return}},sr=(e,r)=>{let s=ce(e);return ie(s,r)},tr=async e=>{let r="email";return await er().findOne({[r]:e[r]})};ue.exports={defineAccessTokenPayload:ce,createAccessToken:ie,generateDefaultAccessTokenPayload:sr,getUserFromTokenPayload:tr,verify:rr}});var S=t((ms,le)=>{var nr=require("lodash"),de=E(),or=async(e,r,s)=>{let n=process.env.JWT_SECRET;if(!n)throw new Error("Missing JWT_SECRET");let o=e.header("x-app-auth-access-token");if(!o)return r.status(400).send("Access denied. Missing required token");let a=de.verify(o,n);if(!a)return r.status(400).send("Access denied. Bad token");let i=await de.getUserFromTokenPayload(a);if(!i)return r.status(400).send("Access denied. Gone");e.accessToken=o,e.user=i,s()},ar=(e=[])=>async(r,s,n)=>{if(!r.user)return s.status(400).send("Unauthorized: Access denied");if(e.length===0)return n();if(nr.intersection(r.user.roles,e).length===0)return s.status(403).send("Forbidden: Access denied");n()};le.exports={authenticated:or,authorized:ar}});var ge=t((hs,pe)=>{var{Router:cr}=require("express"),{authenticated:ir}=S(),{asyncError:ur}=require("@app/lib/middlewares"),k=cr(),dr=(e,r)=>{r.sendStatus(200)};k.get("/ping",(e,r)=>{r.sendStatus(200)});k.get("/__test__/authenticated",[ir],ur(dr));pe.exports=k});var M=t((qs,me)=>{var u=require("joi"),h={fullname:u.string().min(5).max(30),email:u.string().min(5).max(255).email(),password:u.string().min(8).max(30),roles:u.array().items(u.string().valid("admin","user")).min(1)};me.exports={userSchema:h,registerSchema:u.object({fullname:h.fullname.required(),email:h.email.required(),password:h.password.required()})}});var ye=t((ys,qe)=>{var lr=require("joi"),{userSchema:he}=M();qe.exports={loginSchema:lr.object({username:he.email.required(),password:he.password.required()})}});var we=t((fs,fe)=>{var{resourceManager:pr}=require("@app/auth-db/services"),{getModels:gr}=g(),q=()=>gr().User,mr=async e=>await q().findOne(e),hr=async e=>await q().findOne({_id:e}),qr=async e=>{let r=q(),s=e.roles||"user";return await new r({...e,roles:s}).save()},yr=async(e={})=>{let r=q();return await pr.getItems(r,e)};fe.exports={getById:hr,exists:mr,register:qr,list:yr}});var xe=t((ws,Te)=>{var R=require("bcrypt"),fr=async(...e)=>await R.compare(...e),wr=async(e,r=10)=>{let s=await R.genSalt(r);return await R.hash(e,s)};Te.exports={hash:wr,verify:fr}});var _=t((Ts,ve)=>{var Tr=we(),xr=xe(),vr=E();ve.exports={userManager:Tr,passwordManager:xr,tokenManager:vr}});var Me=t((vs,ke)=>{var xs=require("lodash"),Se=require("express").Router(),{validate:Er}=require("@app/lib/api/helpers"),{asyncError:Sr}=require("@app/lib/middlewares"),{loginSchema:kr}=ye(),{userManager:Mr,passwordManager:Rr,tokenManager:Ee}=_(),_r=async(e,r)=>{let s=Er(kr,e.body);if(s)return r.status(400).send(JSON.stringify(s));let n=await Mr.exists({email:e.body.username});if(!n)return r.status(404).send("Invalid credentials");if(!await Rr.verify(e.body.password,n.password))return r.status(401).send("Invalid credentials");let a=Ee.defineAccessTokenPayload(n),i=await Ee.createAccessToken(a,process.env.JWT_SECRET);return r.send(i)};Se.post("/",Sr(_r));ke.exports=Se});var De=t((Es,be)=>{var b=require("lodash"),y=require("express").Router(),{validate:br}=require("@app/lib/api/helpers"),{authenticated:_e,authorized:Dr}=S(),{registerSchema:Pr}=M(),{userManager:D,passwordManager:Ur,tokenManager:Re}=_(),{asyncError:P}=require("@app/lib/middlewares"),Or=async(e,r)=>{let s=e.user;return r.json(b.pick(s,["_id","fullname","email","roles"]))},Ar=async(e,r)=>{let s=await D.list();return r.json(s)},Cr=async(e,r)=>{let s=br(Pr,e.body);if(s)return r.status(400).send(JSON.stringify(s));if(await D.exists({email:e.body.email}))return r.status(400).send("A user with that email already exists");let o=await Ur.hash(e.body.password);e.body.password=o;let a=await D.register(b.pick(e.body,["fullname","email","password"])),i=b.pick(a,["_id","fullname","email"]),T=Re.defineAccessTokenPayload(a),x=await Re.createAccessToken(T,process.env.JWT_SECRET);return r.header("x-app-auth-access-token",x).send(i)};y.get("/me",[_e,Dr(["user"])],P(Or));y.get("/",_e,P(Ar));y.post("/",P(Cr));be.exports=y});var Ue=t((Ss,Pe)=>{var Nr=ge(),$r=Me(),Ir=De();Pe.exports={api:Nr,user:Ir,auth:$r}});var Ae=t((ks,Oe)=>{var{api:Fr,auth:jr,user:Gr}=Ue();Oe.exports=e=>{e.use("/api/auth",jr),e.use("/api/users",Gr),e.use("/api",Fr)}});var Ne=t((Ms,Ce)=>{var Jr=["NODE_ENV","PORT","MONGO_URI","MONGO_TIMEOUTMS","JWT_SECRET","DEBUG"],Br=()=>Jr.find(r=>{if(!process.env[r])return!0});Ce.exports=()=>{let e=!0;if(Br())throw e=!1,new Error("RuntimeError: missing required Env");e||process.exit(1)}});var Ie=t((Rs,$e)=>{var Vr=I(),Wr=V(),zr=L(),Hr=Y(),Lr=re(),Kr=te(),Xr=oe(),Qr=Ae(),Yr=Ne();$e.exports={config:Vr,db:Wr,dev:zr,handlers:Hr,middlewareBefore:Lr,middlewareFinally:Kr,prod:Xr,routes:Qr,sanity:Yr}});var Zr=require("express"),d=Zr(),f=process.env.NODE_ENV||"";try{require("@dotenvx/dotenvx").config({path:`.env${f?"."+f:""}`})}catch{}var w,es=l(),c=Ie();c.config(__dirname);c.handlers(process);c.sanity();c.db();c.middlewareBefore(d);c.routes(d);c.middlewareFinally(d);["test","production"].includes(f)?w=c.prod(d):w=c.dev(__dirname,d);var Fe=process.env.RUN_TEST&&process.env.RUN_TEST_PORT?process.env.RUN_TEST_PORT:process.env.PORT||5001;w.listen(Fe,()=>{es.info(`... Running in ${f||"development"} mode on PORT :${Fe}...`)});module.exports=w;
